name: Build and Release DEB Package

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Extract version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y dpkg-dev

            - name: Update version in control file
              run: |
                  sed -i "s/^Version: .*/Version: ${{ steps.version.outputs.VERSION }}/" packaging/DEBIAN/control

            - name: Build DEB package
              run: |
                  chmod +x build_deb.sh
                  ./build_deb.sh

            - name: Get package filename
              id: package
              run: echo "FILENAME=$(ls build/*.deb)" >> $GITHUB_OUTPUT

            - name: Generate checksum
              run: |
                  cd build
                  sha256sum *.deb > SHA256SUMS

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Kapsulate ${{ steps.version.outputs.VERSION }}
                  draft: false
                  prerelease: false
                  files: |
                      build/*.deb
                      build/SHA256SUMS
                  body: |
                      ## Kapsulate ${{ steps.version.outputs.VERSION }}

                      ### Installation

                      Download the `.deb` file and install it:

                      ```bash
                      sudo dpkg -i kapsulate_${{ steps.version.outputs.VERSION }}_amd64.deb
                      sudo apt-get install -f  # If dependencies are missing
                      ```

                      ### What's New

                      See the [CHANGELOG.md](https://github.com/DarkoKuzmanovic/Kapsulate/blob/main/CHANGELOG.md) for details.

                      ### Verification

                      Verify the package integrity:

                      ```bash
                      sha256sum -c SHA256SUMS
                      ```
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
